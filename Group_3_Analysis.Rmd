---
title: "Group_3_Analysis"
author: "Group_3"
date: "2023-03-10"
output: html_document
---
# Aim of Analysis

# Exploratory Analysis

## Data Wrangling
```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#load library
library(dplyr)
library(tidyr)
library(skimr)
library(tidytext)
library(stringr)
library(e1071)
```

```{r Binary output label}
imdb <- read.csv("https://raw.githubusercontent.com/fanghuaqiu/DMML-Group-3/main/group_3.csv",na.strings = "") %>%
  mutate(ROI = (gross-budget)/budget) %>% #define ROI
  mutate(scs = ifelse(ROI>=1,1,0)) %>% #define binary labelled output
  mutate(title_year = as.factor(title_year),
         aspect_ratio = as.factor((aspect_ratio)),
         scs = as.factor(scs),
         content_rating = replace_na(content_rating, "Unknown"),
         country = str_replace(country," ","_"),
         content_rating = str_replace(content_rating," ","_"))%>%
  mutate(content_rating = str_replace(content_rating,"-1","_1"))
```


```{r turn categorical variable to dummy variable}
#Turn genres into matrix
imdb_genre <- imdb[,c("movie_title","genres")] %>%
  mutate(has=1) %>%
  unnest_tokens(genres_c, genres, to_lower=F) %>%
  filter(genres_c != "Fi" & genres_c != "Film") %>%
  group_by(movie_title) %>%
  spread(genres_c,has,fill=0)

#turn categorical variable into dummy variables
dummies <- model.matrix(~color+language+country+title_year+aspect_ratio+content_rating,data=imdb)[,-1]

#Combine datasets, need to adjust for standised data
imdb_dummy <- cbind(imdb,dummies) %>%
    left_join(imdb_genre, by = "movie_title")

skim(imdb_dummy)
```


```{r Separate training, validation and test sets}
same_sample <- function(x,y){
  set.seed(84)
  return(sample(x,y))
}

index_test <- same_sample(1:nrow(imdb), round(0.25*nrow(imdb)))
index_val <- same_sample((1:nrow(imdb))[-index_test], round(0.25*nrow(imdb)))
index_train <- setdiff(1:nrow(imdb),c(index_test,index_val))

test_imdb <- imdb_dummy[index_test,]
valid_imdb <- imdb_dummy[index_val,]
train_imdb <- imdb_dummy[index_train,]
```

# Modelling

## KNN

## LDA

## Tree

## SVM
```{r datacleaning for SVM}
datacleaning <- function(data){
  data = data[,-c(1,3:10,16:24,25:27,29)]
}#original datacleaning data = data[,-c(31:152,1,3:10,16,17,19:20,25:27,29,168)], treat all the factor as dummies variable.
train_imdb = datacleaning(train_imdb)
valid_imdb = datacleaning(valid_imdb)
test_imdb = datacleaning(test_imdb)

factor <- function(data){
  data[,"color"] = as.factor(data[,"color"])
  data[,"content_rating"] = as.factor(data[,"content_rating"])
  data[,"scs"] = as.factor(data[,"scs"])
  data[,"language"] = as.factor(data[,"language"])
  data[,"country"] = as.factor(data[,"country"])

  return (data)
}
#let genres be factor
  data[,14] = as.factor(data[,14])
  data[,15] = as.factor(data[,15])
  data[,16] = as.factor(data[,16])
  data[,17] = as.factor(data[,17])
  data[,18] = as.factor(data[,18])
  data[,19] = as.factor(data[,19])
  data[,20] = as.factor(data[,20])
  data[,21] = as.factor(data[,21])
  data[,22] = as.factor(data[,22])
  data[,23] = as.factor(data[,23])
  data[,24] = as.factor(data[,24])
  data[,25] = as.factor(data[,25])
  data[,26] = as.factor(data[,26])
  data[,27] = as.factor(data[,27])
  data[,28] = as.factor(data[,28])
  data[,29] = as.factor(data[,29])
  data[,30] = as.factor(data[,30])
  data[,31] = as.factor(data[,31])
  data[,32] = as.factor(data[,32])
  data[,33] = as.factor(data[,33])
  data[,34] = as.factor(data[,34])
  data[,35] = as.factor(data[,35])
  
train_imdb = factor(train_imdb)
valid_imdb = factor(valid_imdb)
test_imdb = factor(test_imdb)

```

```{r SVM}
Model <- svm(scs~.,data = train_imdb, type="C-classification", kernel="linear",cost = 0.1)
summary(Model)
aa2=predict(Model,valid_imdb)
table(valid_imdb$scs,aa2)
length(valid_imdb$scs)
length(aa2)
sum(diag(table(valid_imdb$scs,aa2)))/length(aa2)

cost_range <- c(0.01,0.1,1,10,100,150)
degree_range <- 2:20
gamma_range <- c(0.001,0.01,0.1,1,10,100)

SVM_poly <- tune.svm(scs~., data=train_imdb, type="C-classification", kernel="polynomial", cost=cost_range, degree=degree_range)
summary(SVM_poly)

SVM_RBF <- tune.svm(scs~., data=train_imdb, type="C-classification", kernel="radial", cost=cost_range, gamma=gamma_range)
summary(SVM_RBF)

SVM_linear <- tune.svm(scs~.,data = train_imdb,type="C-classification",kernel="linear",cost = cost_range)
summary(SVM_linear)


gamma_poly_opt <- SVM_poly$best.parameters[1]
cost_poly_opt <- SVM_poly$best.parameters[2]
SVM_poly_final <- svm(scs~., train_imdb, type="C-classification", kernel="polynomial", gamma=gamma_poly_opt, cost=cost_poly_opt)
test_poly_pred <- predict(SVM_poly_final,valid_imdb)
table(valid_imdb$scs,test_poly_pred)
sum(diag(table(valid_imdb$scs,test_poly_pred)))/length(valid_imdb$scs)


gamma_radial_opt <- SVM_RBF$best.parameters[1]
cost_radial_opt <- SVM_RBF$best.parameters[2]
SVM_radial_final <- svm(scs~., train_imdb, type="C-classification", kernel="radial", gamma=gamma_radial_opt, cost=cost_radial_opt)
test_radial_pred <- predict(SVM_radial_final,valid_imdb)
table(valid_imdb$scs,test_radial_pred)
sum(diag(table(valid_imdb$scs,test_radial_pred)))/length(valid_imdb$scs)

#radial preform better, try to use radial SVM to predict
SVM_best = SVM_radial_final
predict_final = predict(SVM_best,test_imdb)
table(test_imdb$scs,predict_final)
sum(diag(table(test_imdb$scs,predict_final)))/length(test_imdb$scs)

cost_linear_opt <- SVM_linear$best.parameters[1]
SVM_linear_final <- svm(scs~., train_imdb, type="C-classification", kernel="linear",cost=cost_linear_opt)
test_linear_pred <- predict(SVM_linear_final,valid_imdb)
table(valid_imdb$scs,test_linear_pred)
sum(diag(table(valid_imdb$scs,test_linear_pred)))/length(valid_imdb$scs)


```

##Neural Network

#Conclusion

```


